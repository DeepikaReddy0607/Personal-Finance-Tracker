<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="{{url_for('static',filename='Tracker.css')}}">

</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container">
        <a class="navbar-brand" href="#">Expense Tracker</a>
        <div>
            <span class="text-white me-3">Hi, {{ username }}</span>
            <a href="{{ url_for('logout') }}" class="btn btn-light btn-sm">Logout</a>
        </div>
    </div>
</nav>

<div class="container my-4">
    <h3>Your Expenses</h3>

    <!-- Budget Section -->
    <div class="alert alert-info">
        <strong>Budget:</strong> {{ budget if budget else 'Not set' }} |
        <strong>Spent:</strong> {{ spent }} |
        <strong>Remaining:</strong> {{ remaining if remaining != None else 'N/A' }}
        <a href="{{ url_for('set_budget') }}" class="btn btn-sm btn-primary float-end">Set Budget</a>
    </div>

    <!-- Add Expense -->
    <div class="card p-3 mb-4">
        <h5>Add New Expense</h5>
        <form method="POST">
            {{ form.hidden_tag() }}
            <div class="row g-2">
                <div class="col-md-3">{{ form.description(class="form-control", placeholder="Description") }}</div>
                <div class="col-md-3">{{ form.amount(class="form-control", placeholder="Amount") }}</div>
                <div class="col-md-3">{{ form.category(class="form-select") }}</div>
                <div class="col-md-3">{{ form.submit(class="btn btn-success w-100") }}</div>
            </div>
        </form>
    </div>

    <!-- Filter -->
    <form class="mb-3">
        <select name="category" onchange="this.form.submit()" class="form-select w-25">
            <option value="">All Categories</option>
            {% for cat in categories %}
                <option value="{{ cat[0] }}" {% if selected_category == cat[0]|string %}selected{% endif %}>{{ cat[1] }}</option>
            {% endfor %}
        </select>
    </form>

    <!-- Expenses Table -->
    <table class="table table-bordered">
        <thead class="table-dark">
            <tr>
                <th>Description</th>
                <th>Amount</th>
                <th>Category</th>
                <th>Date</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            {% for exp in expenses %}
            <tr>
                <td>{{ exp[1] }}</td>
                <td>{{ exp[2] }}</td>
                <td>{{ exp[3] }}</td>
                <td>{{ exp[4] }}</td>
                <td><a href="{{ url_for('delete_expense', expense_id=exp[0]) }}" class="btn btn-danger btn-sm">Delete</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pie Chart -->
    <div class="card p-3 mt-4">
        <h5>Expenses Breakdown (This Month)</h5>
        <div class="chart-container">
            <canvas id="expenseChart"></canvas>
        </div>
    </div>
</div>

<script>
    fetch('/chart-data')
        .then(response => response.json())
        .then(data => {
            const labels = data.map(item => item[0]);
            const amounts = data.map(item => item[1]);
            const ctx = document.getElementById('expenseChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: amounts,
                        backgroundColor: ['#ff6384', '#36a2eb', '#ffce56', '#4caf50', '#9966ff']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        });
</script>
</body>
</html>
